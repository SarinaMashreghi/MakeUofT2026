<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mic → Gemini → ElevenLabs</title>
  <style>
    body { font-family: system-ui, sans-serif; max-width: 900px; margin: 24px auto; padding: 0 12px; }
    button { padding: 10px 14px; margin-right: 8px; }
    .row { margin: 12px 0; display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
    .box { border: 1px solid #ddd; border-radius: 10px; padding: 12px; }
    #status { color: #444; }
    #reply { white-space: pre-wrap; }
    audio { width: 100%; margin-top: 8px; }
    .small { font-size: 0.9rem; color: #666; }
  </style>
</head>
<body>
  <h2>Browser Mic → Gemini → ElevenLabs TTS</h2>
  <p class="small">
    Click <b>Start</b>, speak, then <b>Stop</b>. The server sends your audio to Gemini to generate text,
    then sends that text to ElevenLabs to generate an MP3 you can play.
  </p>

  <div class="row">
    <button id="btnStart">Start Recording</button>
    <button id="btnStop" disabled>Stop</button>
    <span id="status">Idle</span>
  </div>

  <div class="box">
    <h3>Gemini reply</h3>
    <div id="reply">(none yet)</div>
  </div>

  <div class="box" style="margin-top: 12px;">
    <h3>ElevenLabs audio</h3>
    <audio id="player" controls></audio>
  </div>

  <script>
    const btnStart = document.getElementById("btnStart");
    const btnStop  = document.getElementById("btnStop");
    const statusEl = document.getElementById("status");
    const replyEl  = document.getElementById("reply");
    const player   = document.getElementById("player");

    let mediaRecorder;
    let chunks = [];

    function setStatus(s) { statusEl.textContent = s; }

    btnStart.onclick = async () => {
      replyEl.textContent = "(none yet)";
      player.removeAttribute("src");
      chunks = [];

      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        // Many browsers will use audio/webm; server converts to wav if ffmpeg is installed.
        mediaRecorder = new MediaRecorder(stream);

        mediaRecorder.ondataavailable = (e) => {
          if (e.data && e.data.size > 0) chunks.push(e.data);
        };

        mediaRecorder.onstart = () => setStatus("Recording...");
        mediaRecorder.onstop = async () => {
          setStatus("Uploading audio...");
          btnStart.disabled = false;
          btnStop.disabled = true;

          const blob = new Blob(chunks, { type: mediaRecorder.mimeType || "audio/webm" });

          const form = new FormData();
          // filename suffix helps server decide
          form.append("audio", blob, "mic.webm");

          try {
            const res = await fetch("/api/process", { method: "POST", body: form });
            const data = await res.json();

            if (!res.ok) {
              setStatus("Error");
              replyEl.textContent = data.error || "Unknown error";
              return;
            }

            setStatus("Done");
            replyEl.textContent = data.text || "(empty)";
            if (data.audio_url) {
              player.src = data.audio_url + "?t=" + Date.now(); // cache-bust
              player.play().catch(()=>{});
            }
          } catch (err) {
            setStatus("Error");
            replyEl.textContent = String(err);
          }
        };

        mediaRecorder.start();
        btnStart.disabled = true;
        btnStop.disabled = false;

      } catch (err) {
        setStatus("Mic permission error");
        replyEl.textContent = String(err);
      }
    };

    btnStop.onclick = () => {
      if (!mediaRecorder) return;
      setStatus("Stopping...");
      mediaRecorder.stop();
    };
  </script>
</body>
</html>
